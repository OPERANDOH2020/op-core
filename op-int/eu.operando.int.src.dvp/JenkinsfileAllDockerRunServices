#!groovy
node {	
    currentBuild.result = "SUCCESS"
    echo "continueTasks: ${continueTasks}"

	try {
	   def mvnHome 
	   stage('Independent') { 
	      build job: 'eu.operando.int.core.mysql.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.mongo.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.core.as.openldap.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]	          
	   }
	   stage('Dependent lv1') { 
	      //adds structure to DB
	      build job: 'eu.operando.int.core.ldb.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.core.as.cas.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]	          
	   }
	   stage('Dependent lv2') {
		  build job: 'eu.operando.int.pdr.gk.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.pdr.rpm.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.interfaces.rapi.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.interfaces.aapi.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.interfaces.oapi.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.int.core.pdb.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.ae.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.pfb.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.ldb.search.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.bda.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.ose.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.pc.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	      build job: 'eu.operando.int.core.sos.nagios.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	   }
	   stage('Dependent lv3') { 
		  build job: 'eu.operando.dev.demo.mono.yellowpages.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.interfaces.rapi.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.pdr.dan.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.pdr.gk.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.pdr.rpm.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.webui.birt.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.webui.mono.console.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
		  build job: 'eu.operando.dev.webui.mono.reports.server', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]
	   }
	   stage('Dependent lv4') { 
	      //RM has strong dependency over AAPI and it must be run after
		  build job: 'eu.operando.int.core.rm.server.jnk.tsk.run', propagate: false, parameters: [booleanParam(name: 'continueTasks', value: false)]	          
		  build job: 'eu.operando.dev.demo.setup.scripts', propagate: false	 , parameters: [booleanParam(name: 'continueTasks', value: false)]  
	   }
	   if (continueTasks == 'true') {
	       stage('continue') {
	   	        build job: 'eu.operando.int.jnk.tsk.run.tests', wait: false
	   	   }
	   }
	   	   	   
	  } catch (err) {

        currentBuild.result = "FAILURE"

			  emailext (
			      subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
			      body: """<p>FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
			        <p>Check console output at &QUOT;<a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>&QUOT;</p>""",
			      recipientProviders: [[$class: 'DevelopersRecipientProvider']]
			    )

        throw err
		}
}

